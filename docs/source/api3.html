<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">(function(jQuery) {
&quot;use strict&quot;;

var $ = jQuery;

Echo.API = {&quot;Transports&quot;: {}, &quot;Request&quot;: {}};

var utils = Echo.Utils;

<span id='Echo-API-Transport'>/**
</span> * @class Echo.API.Transport
 */
Echo.API.Transport = function(config) {
	this.config = new Echo.Configuration(config, {
		&quot;data&quot;: {},
		&quot;uri&quot;: &quot;&quot;,
		&quot;secure&quot;: false,
		&quot;onData&quot;: function() {},
		&quot;onOpen&quot;: function() {},
		&quot;onClose&quot;: function() {},
		&quot;onError&quot;: function() {}
	});
	this.transportObject = this._getTransportObject();
};

Echo.API.Transport.prototype._wrapErrorResponse = function(responseError) {
	return {
		&quot;result&quot;: &quot;error&quot;,
		&quot;errorCode&quot;: &quot;connection_failure&quot;,
		&quot;errorMessage&quot;: &quot;&quot;,
		&quot;transportError&quot;: responseError || &quot;&quot;
	};
};

Echo.API.Transport.prototype._prepareURL = function() {
	return this._getScheme() + &quot;//&quot; + this.config.get(&quot;uri&quot;);
};

<span id='Echo-API-Transports-AJAX'>/**
</span> * @class Echo.API.Transports.AJAX
 * @extends Echo.API.Transport
 */
Echo.API.Transports.AJAX = function(config) {
	config = $.extend({
		&quot;method&quot;: &quot;get&quot;
	}, config || {});
	return Echo.API.Transports.AJAX.parent.constructor.call(this, config);
};

utils.inherit(Echo.API.Transport, Echo.API.Transports.AJAX);

Echo.API.Transports.AJAX.prototype._getScheme = function() {
	return this.config.get(&quot;secure&quot;) ? &quot;https:&quot; : &quot;http:&quot;;
};

Echo.API.Transports.AJAX.prototype._getTransportObject = function() {
	var self = this;
	var domain = utils.parseURL(document.location.href).domain;
	var targetDomain = utils.parseURL(this.config.get(&quot;uri&quot;)).domain;
	return {
		&quot;url&quot;: this._prepareURL(),
		&quot;type&quot;: this.config.get(&quot;method&quot;),
		&quot;error&quot;: function(errorResponse, requestParams) {
			errorResponse = self._wrapErrorResponse(errorResponse);
			if (errorResponse.transportError &amp;&amp; errorResponse.transportError.statusText === &quot;abort&quot;) {
				errorResponse.errorCode = &quot;connection_aborted&quot;;
			}
			self.config.get(&quot;onError&quot;)(errorResponse, requestParams);
		},
		&quot;success&quot;: this.config.get(&quot;onData&quot;),
		&quot;crossDomain&quot;: true,
		&quot;beforeSend&quot;: this.config.get(&quot;onOpen&quot;),
		&quot;dataType&quot;: &quot;json&quot;
	};
};

Echo.API.Transports.AJAX.prototype._wrapErrorResponse = function(responseError) {
	var originalWrapped = Echo.API.Transports.AJAX.parent._wrapErrorResponse.apply(this, arguments);
	if (responseError &amp;&amp; responseError.responseText) {
		var errorObject;
		try {
			errorObject = $.parseJSON(responseError.responseText);
		} catch(e) {}
		return errorObject || originalWrapped;
	}
	return originalWrapped;
};

Echo.API.Transports.AJAX.prototype.send = function(data) {
	this.transportObject.data = $.extend({}, this.config.get(&quot;data&quot;), data || {});
	this.transportObject = $.ajax(this.transportObject);
};

Echo.API.Transports.AJAX.prototype.abort = function() {
	if (this.transportObject) {
		this.transportObject.abort();
	}
	this.config.get(&quot;onClose&quot;)();
};

Echo.API.Transports.AJAX.available = function() {
	return !$.browser.msie;
};

<span id='Echo-API-Transports-XDomainRequest'>/**
</span> * @class Echo.API.Transports.XDomainRequest
 * @extends Echo.API.Transports.AJAX
 */
Echo.API.Transports.XDomainRequest = function(config) {
	return Echo.API.Transports.XDomainRequest.parent.constructor.apply(this, arguments);
};

utils.inherit(Echo.API.Transports.AJAX, Echo.API.Transports.XDomainRequest);

Echo.API.Transports.XDomainRequest.prototype._getTransportObject = function() {
	var self = this;
	var xdr = new XDomainRequest();
	var parseResponseText = function(responseText) {
		var data;
		try {
			data = $.parseJSON(responseText);
		} catch(e) {
			data = {
				&quot;result&quot;: &quot;error&quot;,
				&quot;errorCode&quot;: &quot;parse_error&quot;,
				&quot;errorMessage&quot;: &quot;Parse JSON error&quot;
			};
		}
		return data;
	};
	xdr.onload = function() {
		self.config.get(&quot;onData&quot;)(parseResponseText(xdr.responseText));
	};
	xdr.onerror = function() {
		var errorResponse = self._wrapErrorResponse(parseResponseText(xdr.responseText));
		self.config.get(&quot;onError&quot;)(errorResponse);
	};
	return xdr;
};

Echo.API.Transports.XDomainRequest.prototype.send = function(data) {
	data = $.extend(true, {}, this.config.get(&quot;data&quot;), data || {});
	var method = this.config.get(&quot;method&quot;).toLowerCase();
	this.config.get(&quot;onOpen&quot;)();
	// TODO: need investigate XDomainRequest cache
	// avoid recieved data caching
	$.extend(data, {
		&quot;_echo&quot;: utils.getUniqueString()
	});
	if (method === &quot;get&quot;) {
		this.transportObject.open(method, this._prepareURL() + &quot;?&quot; + $.param(data));
		this.transportObject.send(null);
	} else {
		this.transportObject.open(method, this._prepareURL());
		this.transportObject.send($.param(data));
	}
};

Echo.API.Transports.XDomainRequest.prototype.abort = function() {
	Echo.API.Transports.XDomainRequest.parent.abort.call(this);
	this.config.get(&quot;onError&quot;)(
		$.extend(true, this._wrapErrorResponse(), {
			&quot;errorCode&quot;: &quot;connection_aborted&quot;
		})
	);
};

Echo.API.Transports.XDomainRequest.available = function() {
	return $.browser.msie
		&amp;&amp; $.browser.version &gt; 7
		&amp;&amp; &quot;XDomainRequest&quot; in window
		&amp;&amp; window.XDomainRequest !== null;
};

<span id='Echo-API-Transports-JSONP'>/**
</span> * @class Echo.API.Transports.JSONP
 * @extends Echo.API.Transports.AJAX
 */
Echo.API.Transports.JSONP = function(config) {
	return Echo.API.Transports.JSONP.parent.constructor.apply(this, arguments);
};

utils.inherit(Echo.API.Transports.AJAX, Echo.API.Transports.JSONP);

Echo.API.Transports.JSONP.prototype.send = function(data) {
	if (this.config.get(&quot;method&quot;).toLowerCase() === &quot;get&quot;) {
		this.transportObject.data = $.extend({}, this.config.get(&quot;data&quot;), data);
		return $.ajax(this.transportObject);
	}
	this._pushPostParameters($.extend({}, this.config.get(&quot;data&quot;), data));
	this.transportObject.submit();
	this.config.get(&quot;onData&quot;)();
};

Echo.API.Transports.JSONP.prototype._getTransportObject = function() {
	var settings = this.constructor.parent._getTransportObject.call(this);
	if (this.config.get(&quot;method&quot;).toLowerCase() === &quot;post&quot;) {
		return this._getPostTransportObject({
			&quot;url&quot;: settings.url
		});
	}
	delete settings.xhr;
	settings.dataType = &quot;jsonp&quot;;
	return settings;
};

Echo.API.Transports.JSONP.prototype._getPostTransportObject = function(settings) {
	var id = &quot;echo-post-&quot; + Math.random();
	var container =
		$(&quot;#echo-post-request&quot;).length
			? $(&quot;#echo-post-request&quot;).empty()
			: $('&lt;div id=&quot;echo-post-request&quot;/&gt;').css({&quot;height&quot;: 0}).prependTo(&quot;body&quot;);
	// it won't work if the attributes are specified as a hash in the second parameter
	this.iframe = this.iframe || $('&lt;iframe id=&quot;' + id + '&quot; name=&quot;' + id + '&quot; width=&quot;0&quot; height=&quot;0&quot; frameborder=&quot;0&quot; border=&quot;0&quot;&gt;&lt;/iframe&gt;').appendTo(container);
	var form = $(&quot;&lt;form/&gt;&quot;, {
		&quot;target&quot; : id,
		&quot;method&quot; : &quot;POST&quot;,
		&quot;enctype&quot; : &quot;application/x-www-form-urlencoded&quot;,
		&quot;acceptCharset&quot; : &quot;UTF-8&quot;,
		&quot;action&quot; : settings.url
	}).appendTo(container);
	this._pushPostParameters(settings.data);
	return form;
};

Echo.API.Transports.JSONP.prototype._pushPostParameters = function(data) {
	var self = this;
	$.each(data || {}, function(key, value) {
		$(&quot;&lt;input/&gt;&quot;, {
			&quot;type&quot; : &quot;hidden&quot;,
			&quot;name&quot; : key,
			&quot;value&quot; : value
		}).appendTo(self.transportObject);
	});
	return self.transportObject;
};

Echo.API.Transports.JSONP.available = function() {
	return true;
};

<span id='Echo-API-Transports-WebSocket'>/**
</span> * @class Echo.API.Transports.WebSocket
 * @extends Echo.API.Transport
 */
Echo.API.Transports.WebSocket = function(config) {
	return Echo.API.Transports.WebSocket.parent.constructor.apply(this, arguments);
};

utils.inherit(Echo.API.Transport, Echo.API.Transports.WebSocket);

Echo.API.Transports.WebSocket.prototype._getScheme = function() {
	return this.config.get(&quot;secure&quot;) ? &quot;wss:&quot; : &quot;ws:&quot;;
};

Echo.API.Transports.WebSocket.prototype._getTransportObject = function() {
	var self = this;
	var socket = new (window.WebSocket || window.MozWebSocket)(this._prepareURL());
	socket.onmessage = function(event) {
		self.config.get(&quot;onData&quot;)($.parseJSON(event.data));
	};
	socket.onopen = this.config.get(&quot;onOpen&quot;);
	socket.onclose = this.config.get(&quot;onClose&quot;);
	socket.onerror = function(errorResponse, requestParams) {
		errorResponse = self._wrapErrorResponse(errorResponse);
		self.config.get(&quot;onError&quot;)(errorResponse, requestParams);
	};
	return socket;
};

Echo.API.Transports.WebSocket.prototype.send = function(params) {
	this.transportObject.send(utils.objectToJSON(params));
};

Echo.API.Transports.WebSocket.prototype.abort = function() {
	this.config.get(&quot;onClose&quot;)();
};

Echo.API.Transports.WebSocket.available = function() {
	// FIXME: fix when server will support Web Sockets
	return false;
	//return (&quot;WebSocket&quot; in window || &quot;MozWebSocket&quot; in window);
};

<span id='Echo-API-Request'>/**
</span> * @class Echo.API.Request
 * Class implementing API requests logic on the transport layer.
 */
/*
 * @constructor
 * @param {Object} config
 * Configuration data.
 */
Echo.API.Request = function(config) {
<span id='Echo-API-Request-cfg-endpoint'>	/**
</span>	 * @cfg {String} endpoint
	 * Specifes the API endpoint.
	 */
	if (!config || !config.endpoint) return;
	this.config = new Echo.Configuration(config, {
<span id='Echo-API-Request-cfg-onData'>		/**
</span>		 * @cfg {Function} [onData]
		 * Callback called after API request succeded.
		 */
<span id='Echo-API-Request-cfg-onError'>		/**
</span>		 * @cfg {Function} [onError]
		 * Callback called after API request failed. 
		 */
<span id='Echo-API-Request-cfg-onOpen'>		/**
</span>		 * @cfg {Function} [onOpen]
		 * Callback called before sending an API request.
		 */
<span id='Echo-API-Request-cfg-onClose'>		/**
</span>		 * @cfg {Function} [onClose]
		 * Callback called after API request aborting.
		 */
<span id='Echo-API-Request-cfg-apiBaseUrl'>		/**
</span>		 * @cfg {String} [apiBaseUrl]
		 * Specifies the base URL for API requests
		 */
		&quot;apiBaseURL&quot;: &quot;api.echoenabled.com/v1/&quot;,
<span id='Echo-API-Request-cfg-transport'>		/**
</span>		 * @cfg {String} [transport]
		 * Specifies the transport name.
		 */
		&quot;transport&quot;: &quot;ajax&quot;,
<span id='Echo-API-Request-cfg-method'>		/**
</span>		 * @cfg {String} [method]
		 * Specifies the request method.
		 */
		&quot;method&quot;: &quot;GET&quot;,
<span id='Echo-API-Request-cfg-timeout'>		/**
</span>		 * @cfg {Number} [timeout]
		 * Specifies the number of seconds after which onError callback will be
		 * called if API request failed.
		 */
		&quot;timeout&quot;: 30
	});
};

Echo.API.Request.prototype._isSecureRequest = function() {
	var parts = utils.parseURL(this.config.get(&quot;apiBaseURL&quot;));
	if (!parts.scheme) return false;
	return /https|wss/.test(parts.scheme);
};

<span id='Echo-API-Request-method-send'>/**
</span> * Method performing api request using given parameters.
 *
 * @param {Object} [args] Request parameters.
 * @param {Boolean} [args.force] Flag to initiate aggressive polling.
 */
Echo.API.Request.prototype.send = function(args) {
	var force = false;
	if (args) {
		force = args.force;
		delete args.force;
		this.config.extend(args);
	}
	var method = this[&quot;_&quot; + this.config.get(&quot;endpoint&quot;)];
	method &amp;&amp; method.call(this, force);
};

//TODO: probably we should replace request with _request or simply not documenting it
Echo.API.Request.prototype.request = function(params) {
	var self = this;
	var timeout = this.config.get(&quot;timeout&quot;);
	this.transport = this._getTransport();
	if (this.transport) {
		this.transport.send(params);
		if (timeout &amp;&amp; this.config.get(&quot;onError&quot;)) {
			this._timeoutId = setTimeout(function() {
				self.config.get(&quot;onError&quot;)({
					&quot;result&quot;: &quot;error&quot;,
					&quot;errorCode&quot;: &quot;network_timeout&quot;
				}, {
					&quot;requestType&quot;: self.requestType,
					&quot;critical&quot;: true
				});
				self.transport.abort();
			}, timeout * 1000);
		}
	}
};

Echo.API.Request.prototype._onData = Echo.API.Request.prototype._onError = function(response) {
	clearTimeout(this._timeoutId);
};

Echo.API.Request.prototype.abort = function() {
	this.transport &amp;&amp; this.transport.abort();
};

Echo.API.Request.prototype._getTransport = function() {
	var self = this;
	var userDefinedTransport = utils.foldl(&quot;&quot;, Echo.API.Transports, function(constructor, acc, name) {
		if (self.config.get(&quot;transport&quot;).toLowerCase() === name.toLowerCase()) {
			return name;
		}
	});
	var transport = Echo.API.Transports[userDefinedTransport] &amp;&amp; Echo.API.Transports[userDefinedTransport].available()
		? userDefinedTransport
		: function() {
			var transport;
			$.each([&quot;WebSocket&quot;, &quot;AJAX&quot;, &quot;XDomainRequest&quot;, &quot;JSONP&quot;], function(i, name) {
				var available = Echo.API.Transports[name].available();
				if (available) {
					transport = name;
					return false;
				}
			});
			return transport;
		}();
	return new Echo.API.Transports[transport](
		$.extend(this._getHandlersByConfig(), {
			&quot;uri&quot;: this._prepareURI(),
			&quot;data&quot;: this.config.get(&quot;data&quot;),
			&quot;method&quot;: this.config.get(&quot;method&quot;),
			&quot;secure&quot;: this._isSecureRequest()
		})
	);
};

Echo.API.Request.prototype._getHandlersByConfig = function() {
	return utils.foldl({}, this.config.getAsHash(), function(value, acc, key) {
		if (/^on[A-Z]/.test(key)) {
			acc[key] = value;
		}
	});
};

Echo.API.Request.prototype._prepareURI = function() {
	return this.config.get(&quot;apiBaseURL&quot;).replace(/^(http|ws)s?:\/\//, &quot;&quot;) + this.config.get(&quot;endpoint&quot;);
};

})(Echo.jQuery);
</pre>
</body>
</html>
